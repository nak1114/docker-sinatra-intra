h2 テスト
button#app1 TRtoZip
label#msg1
br
button#app2 Pdf2Zip 
label#msg2
br
br

== link_to "/tr"
== link_to "/pdf"

javascript:
  (function (){
    var connect = function(){
      var msg1=document.getElementById("msg1");
      var msg2=document.getElementById("msg2");
      var btn1=document.getElementById("app1");
      var btn2=document.getElementById("app2");
      var ws = new WebSocket('wss://' + window.location.host + "/websocket");
      var timer_id=undefined;
      
      function dummy_msg(){
        ws.send("{}");
      }

      ws.onopen = function() { 
        console.log("connection opened");
        if(timer_id==undefined){
          timer_id=setInterval(dummy_msg,20000);
        }
      }
      ws.onclose = function() { 
        console.log("connection closed");
        //setTimeout(function() {connect();}, 1000);
        if(timer_id!=undefined){
          clearInterval(timer_id);
          timer_id=undefined;
        }
      }
      ws.onmessage = function(m) {
        console.log(m);
        var json=JSON.parse(m.data);
        json.forEach(function(v){
          switch (v['action']){
            case 'tr':
              msg1.textContent=' '+v['complete']+'/'+v['total'];
            break;
            case 'pdf':
              msg2.textContent=' '+v['complete']+'/'+v['total'];
            break;
          }
        });
      }

      btn1.onclick = function(){
        var msg={action: "tr"}
        ws.send(JSON.stringify(msg));
        return false;
      }
      btn2.onclick = function(){
        var msg={action: "pdf"}
        ws.send(JSON.stringify(msg));
        return false;
      }
    }
    window.onload=connect();
  })();
